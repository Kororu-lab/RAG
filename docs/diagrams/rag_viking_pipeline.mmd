flowchart TD
  Q[User Query] --> UI[Streamlit UI<br/>src/ui/graph_web.py]
  UI --> LG[LangGraph App<br/>src/agent/graph.py]
  LG --> RETN[retrieve node]

  RETN --> META[Extract Query Metadata<br/>lang detection + intent/topic hints]
  META --> VR[Viking Router<br/>taxonomy-aware scope selection]
  VR --> VS[Viking Scope<br/>patterns + confidence + trace]

  %% Scoped Retrieval (Vector first)
  VS --> VEC[Vector Search (scoped)<br/>pgvector SQL + lang filter + scope patterns]
  VEC --> FB{Soft mode AND<br/>hits &lt; min_hits AND<br/>attempts &lt; max_expansions?}

  FB -- yes --> WIDEN[Widen Scope (controlled)<br/>phenomenon → category → lang-only → global]
  WIDEN --> VEC

  FB -- no --> BM25[BM25 Search (global keywords)<br/>candidate pool for fusion]

  %% BM25 pre-filter policy depends on Viking mode
  BM25 --> PRE{Viking mode?}
  PRE -- strict --> BMF[BM25 Pre-filter (strict)<br/>keep only in-scope candidates]
  PRE -- soft --> BMS[Skip BM25 pre-filter (soft)<br/>allow BM25 into fusion]

  %% Fusion decision and semantics clarification
  BMF --> FCHK{Hybrid enabled AND<br/>BM25 candidates &gt; 0?}
  BMS --> FCHK

  FCHK -- yes --> RRF[RRF Fusion<br/>merge vector + BM25 candidates]
  FCHK -- no --> VO[Vector-only path<br/>(note: BM25 may be 0 after strict filter)]

  %% Scope guard after fusion (important semantics)
  RRF --> SG[Viking Scope Guard<br/>strict: hard drop out-of-scope<br/>soft: drop out-of-scope unless in-scope &lt; MIN_IN_SCOPE]
  VO --> SG

  %% Retrieval post-processing
  SG --> REC[Recursive Retrieval / RAPTOR (optional)<br/>tree/child expansion]
  REC --> RR[Reranker (optional)]
  RR --> SE[Sibling Expansion (optional)<br/>fill title-only chunks]
  SE --> CTX[Final Context Pack<br/>doc ids + paths + snippets]

  %% Downstream LangGraph remains unchanged
  CTX --> GD[grade_documents (optional skip)]
  GD --> DEC{Relevant docs?}
  DEC -- no --> RW[rewrite + retry]
  RW --> RETN
  DEC -- yes --> GEN[generate]
  GEN --> HC[check_hallucination (optional skip)]
  HC --> OUT[Answer + References]

  %% UX note for strict mode
  VO -. strict may yield 0 docs .-> NOTE[UI should warn if strict scope returns 0 docs<br/>suggest soft mode / widen policy]

