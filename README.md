# LTDB Advanced RAG System

LTDB Database를 이용한 RAG 시스템.

*HTML 자료*를 내장하고 있다고 가정함. 형식은 LTDB Database([소수 민족 언어 유형 데이터베이스](http://www.typologydb.org/wiki/))를 따름.

Major portion of the code is generated by AI

---


## System Architecture

### 시스템 아키텍처 (System Architecture)

본 시스템은 **데이터 적재(Ingestion)**와 **실시간 검색/생성(Runtime)** 두 가지 주요 파이프라인으로 구성.

```text
[ 데이터 적재 파이프라인 (Data Ingestion) ]
      |
      v
      |       v
      |     [ src/ingest/run_ingest.sh ] (총괄 스크립트)
      |       |
      |       |=== 1. 시각 정보 (Vision)
      |       |     |
      |       |     +---> [ src/ingest/vision/vision_ingest.py ] --- (HTML 캡처) ---> [ Vision Data ]
      |       |     |
      |       |     +---> [ src/ingest/vision/colpali_ingest.py ] -- (임베딩 생성) --> [ ColPali DB ]
      |       |
      |       |=== 2. 텍스트 정보 (Matrix RAPTOR)
      |             |
      |             +---> [ src/ingest/raptor/raptor_level0.py ] <=== (Util: src/ingest/xsampa_converter.py)
      |             |       | (HTML -> 텍스트/음소 변환 및 청크 추출)
      |             |       v
      |             |     [ data/raptor/matrix_raptor_L0_data.jsonl ]
      |             |
      |             +---> [ src/ingest/raptor/raptor_level1.py ]
      |             |       | (L0 데이터 -> 계층적 요약 수행)
      |             |       v
      |             |     [ data/raptor/matrix_raptor_L1_data.jsonl ]
      |             |
      |             +---> [ src/ingest/raptor/raptor_finalize.py ] --- (DB 적재) ---> [ Postgres (linguistics_raptor) ]


[ 런타임 파이프라인 (Runtime: Retrieval & Generation) ]
      |
      | (사용자 질문)
      v
[ src/main.py ] (Semantic Router: 의도 파악 및 라우팅)
      |
      |--- [ Intent: GRAPH ] ---> [ src/retrieval/graph_search.py ]
      |                             | (Neo4j Cypher 쿼리 실행)
      |                             v
      |                           [ Neo4j Database ]
      |
      |--- [ Intent: VECTOR ] ---> [ src/retrieve/rag_retrieve.py ]
      |                             | (하이브리드 검색: ColPali + Chroma/Postgres)
      |                             +---> [ src/retrieve/colpali_search.py ]
      |                             v
      |                           [ Retrieved Context (JSON) ]
      |
      v
[ src/llm/rag_generate.py ] (답변 생성)
      | (컨텍스트 + 프롬프트)
      v
[ LLM (Ollama: llama3, etc.) ]
      |
      v
[ 최종 답변 (Final Answer) ]
```

---

## 환경 준비

### 1. 환경 설정 (Environment Setup)
의존성 패키지와 데이터베이스 인프라 실행.

```bash
# 파이썬 의존성 설치
uv sync

# Neo4j 및 Postgres (RAPTOR용) 실행
sudo docker-compose up -d
```

### 2. 데이터 적재 (Data Ingestion)
검색에 필요한 인덱스 구축.

**자동화 파이프라인 (`run_ingest.sh`)**
이 스크립트는 다음 단계들을 순차적으로 수행함:
1.  **Vision Capture**: HTML 내용을 이미지로 캡처.
2.  **Visual Indexing**: 캡처된 이미지를 ColPali 임베딩으로 변환.
3.  **Matrix RAPTOR**:
    *   **Level 0**: HTML에서 텍스트 청크 추출.
    *   **Level 1**: 청크들을 요약하여 상위 계층(Summary) 생성. (순환 요약 방지 및 패턴 종합 적용됨)
    *   **Finalize**: 최종 데이터를 PostgreSQL (PGVector)에 적재.

```bash
# Playwright 브라우저 설치 (최초 1회)
uv run playwright install

# 전체 파이프라인 실행
# 전체 파이프라인 실행 (프로젝트 루트에서 실행)
./src/ingest/run_ingest.sh
```

## Running the System
총 3가지 방법으로 구동 가능함.

### 1. main.py 사용

```bash
uv run src/main.py
```

### 2. LangGraph 사용

```bash
uv run src/agent/graph.py
```

### 3. LangGraph(with WebUI) 사용

streamlit을 이용하여 호출함에 유의.

```bash
uv run streamlit run src/ui/graph_web.py
```


## Configuration (`config.yaml`)

주요 설정 항목은 다음과 같음.

### LLM 설정 (Ingestion/Retrieval 분리)
- **`llm_ingestion`**: 데이터 구축(Ingestion) 시 사용할 LLM. (안정성 중시)
  - `provider`: `ollama` 추천.
  - `model_name`: 사용할 모델명 (예: `gpt-oss:20b`).
  - `temperature`: 기본값 `0.1` (사실성 유지 및 Logit locking 방지).
- **`llm_retrieval`**: 검색 및 답변 생성(Retrieval) 시 사용할 LLM. (Ingestion과 다른 모델 지정 가능)

### Retrieval & Embedding
- **`embedding`**: 임베딩 모델 설정.
  - `model_name`: `BAAI/bge-m3` 등.
  - `device`: `cuda` (기본값) 또는 `cpu`.
- **`retrieval`**:
  - `k`: 1차 검색 문서 수 (예: `30`).
- **`reranker`**: 리랭커(Cross-Encoder) 설정. 검색 품질 향상의 핵심.
  - `enabled`: 리랭킹 사용 여부 (`true`/`false`).
  - `model_name`: `BAAI/bge-reranker-v2-m3` 등 성능 좋은 Re-ranker 권장.
  - `top_n`: 최종 선별 문서 수 (예: `5`).

### Database & Graph
- **`database`**: Vector Store(PostgreSQL/pgvector) 연결 정보. `table_name`으로 테이블 지정 가능.
- **`neo4j`**: Graph DB 연결 정보.
- **`rag`**:
  - `enable_graph`: Graph RAG(Semantic Router) 활성화 여부. (`src/main.py` 사용 시 적용)

